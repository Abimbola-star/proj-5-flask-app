---
- name: Gather facts
  setup:
  
- name: Install Docker on Amazon Linux
  command: amazon-linux-extras install -y docker
  when: ansible_distribution == "Amazon"
  register: docker_install_amazon
  changed_when: docker_install_amazon.rc == 0 and "Installing" in docker_install_amazon.stdout
  become: true

- name: Install Docker on CentOS/RHEL
  yum:
    name: docker
    state: present
  when: ansible_os_family == "RedHat" and ansible_distribution != "Amazon"
  become: true

- name: Install Docker on Debian/Ubuntu
  apt:
    name: docker.io
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"
  become: true

- name: Start and enable Docker service
  systemd:
    name: docker
    state: started
    enabled: yes
  become: true

- name: Check if Nexus container exists
  shell: docker ps -a | grep -q nexus
  register: nexus_exists
  changed_when: false
  failed_when: false
  become: true

- name: Pull Nexus image
  command: docker pull sonatype/nexus3:latest
  when: nexus_exists.rc != 0
  become: true

- name: Run Nexus container
  command: docker run -d --name nexus -p 8081:8081 --restart always sonatype/nexus3:latest
  when: nexus_exists.rc != 0
  become: true
...